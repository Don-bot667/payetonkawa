---
import Layout from '../layouts/Layout.astro';
import Hero from '../components/Hero.astro';
---

<Layout title="Accueil">
    <Hero />

    <!-- Section Produits en vedette -->
    <section class="py-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-12">
                <h2 class="text-3xl font-bold text-gray-900">Nos cafes en vedette</h2>
                <p class="text-gray-600 mt-2">Selection de nos meilleurs cafes</p>
            </div>

            <div id="featured-products" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="col-span-full text-center py-12 text-gray-500">
                    Chargement des produits...
                </div>
            </div>

            <div class="text-center mt-10">
                <a href="/produits" class="btn-secondary">
                    Voir tous les cafes
                </a>
            </div>
        </div>
    </section>

    <!-- Section Avantages -->
    <section class="py-16 bg-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="text-center p-6">
                    <div class="w-16 h-16 bg-marron-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-3xl">üåç</span>
                    </div>
                    <h3 class="font-semibold text-lg mb-2">Origines selectionnees</h3>
                    <p class="text-gray-600 text-sm">Cafes provenant des meilleures plantations du monde</p>
                </div>
                <div class="text-center p-6">
                    <div class="w-16 h-16 bg-marron-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-3xl">üî•</span>
                    </div>
                    <h3 class="font-semibold text-lg mb-2">Torrefaction artisanale</h3>
                    <p class="text-gray-600 text-sm">Torrefie en petites quantites pour une fraicheur optimale</p>
                </div>
                <div class="text-center p-6">
                    <div class="w-16 h-16 bg-marron-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-3xl">üöö</span>
                    </div>
                    <h3 class="font-semibold text-lg mb-2">Livraison rapide</h3>
                    <p class="text-gray-600 text-sm">Livre chez vous en 48h</p>
                </div>
            </div>
        </div>
    </section>
</Layout>

<script>
    import { getProduits } from '../lib/api';
    import { addToCart } from '../lib/cart';

    const placeholderImages = [
        "/img/image_de_graine_de_cafe.jpg",
        "https://images.unsplash.com/photo-1514432324607-a09d9b4aefdd?w=400&q=80",
        "https://images.unsplash.com/photo-1497935586351-b67a49e012bf?w=400&q=80",
        "https://images.unsplash.com/photo-1511920170033-f8396924c348?w=400&q=80",
    ];

    async function loadProducts() {
        const container = document.getElementById('featured-products');
        if (!container) return;

        try {
            const produits = await getProduits();
            const featured = produits.slice(0, 4);

            if (featured.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500">Aucun produit disponible</div>';
                return;
            }

            container.innerHTML = featured.map((p, i) => {
                const image = p.image_url
                    ? 'http://localhost:8001' + p.image_url
                    : placeholderImages[i % placeholderImages.length];
                return `
                <div class="product-card bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100">
                    <a href="/produit/${p.id}">
                        <div class="aspect-square overflow-hidden">
                            <img
                                src="${image}"
                                alt="${p.nom}"
                                class="w-full h-full object-cover hover:scale-110 transition-transform duration-300"
                            />
                        </div>
                    </a>
                    <div class="p-4">
                        <a href="/produit/${p.id}">
                            <h3 class="font-semibold text-gray-900 hover:text-marron-600 transition">${p.nom}</h3>
                        </a>
                        ${p.origine ? `<p class="text-sm text-gray-500 mt-1">Origine : ${p.origine}</p>` : ''}
                        <div class="flex items-center justify-between mt-3">
                            <span class="text-lg font-bold text-marron-600">${p.prix.toFixed(2)} EUR</span>
                            <button
                                class="add-to-cart bg-marron-600 text-white px-3 py-1.5 rounded-lg text-sm font-medium hover:bg-marron-700 transition"
                                data-id="${p.id}"
                                data-nom="${p.nom}"
                                data-prix="${p.prix}"
                                data-image="${image}"
                            >
                                Ajouter
                            </button>
                        </div>
                    </div>
                </div>
            `}).join('');

            container.querySelectorAll('.add-to-cart').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const target = e.currentTarget as HTMLElement;
                    addToCart({
                        produit_id: parseInt(target.dataset.id!),
                        nom: target.dataset.nom!,
                        prix: parseFloat(target.dataset.prix!),
                        image: target.dataset.image
                    });
                    target.textContent = 'Ajoute !';
                    target.classList.add('bg-green-600');
                    setTimeout(() => {
                        target.textContent = 'Ajouter';
                        target.classList.remove('bg-green-600');
                    }, 1000);
                });
            });

        } catch (error) {
            container.innerHTML = '<div class="col-span-full text-center py-12 text-red-500">Erreur de chargement des produits. Verifiez que l\'API est demarree.</div>';
        }
    }

    loadProducts();
</script>
